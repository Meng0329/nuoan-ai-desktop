name: æž„å»º macOS æ¡Œé¢åº”ç”¨

on:
  # æ‰‹åŠ¨è§¦å‘ï¼ˆæœ€å¸¸ç”¨ï¼‰
  workflow_dispatch:
  
  # æŽ¨é€ tag æ—¶è‡ªåŠ¨è§¦å‘ï¼ˆå¯é€‰ï¼‰
  push:
    tags:
      - 'v*'
  
  # æŽ¨é€åˆ° main åˆ†æ”¯æ—¶è§¦å‘ï¼ˆå¯é€‰ï¼‰
  # push:
  #   branches:
  #     - main

jobs:
  build-mac:
    name: æž„å»º macOS åº”ç”¨
    runs-on: macos-latest  #ä½¿ç”¨ GitHub æä¾›çš„çœŸå®ž macOS çŽ¯å¢ƒ
    
    steps:
    # 1. æ£€å‡ºä»£ç 
    - name: æ£€å‡ºä»£ç 
      uses: actions/checkout@v4
    
    # 2. è®¾ç½® Node.js çŽ¯å¢ƒ
    - name: è®¾ç½® Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
    
    # 3. æ˜¾ç¤ºç³»ç»Ÿä¿¡æ¯
    - name: æ˜¾ç¤ºç³»ç»Ÿä¿¡æ¯
      run: |
        echo "ç³»ç»Ÿä¿¡æ¯:"
        echo "æ“ä½œç³»ç»Ÿ: $(uname -s)"
        echo "æž¶æž„: $(uname -m)"
        echo "Node.js: $(node --version)"
        echo "npm: $(npm --version)"
        echo "å·¥ä½œç›®å½•: $(pwd)"
    
    # 4. å®‰è£…ä¾èµ–
    - name: å®‰è£…ä¾èµ–
      working-directory: desktop
      run: |
        echo "å¼€å§‹å®‰è£…ä¾èµ–..."
        npm install
        echo "ä¾èµ–å®‰è£…å®Œæˆ"
    
    # 5. æ˜¾ç¤ºé…ç½®ä¿¡æ¯
    - name: æ£€æŸ¥é…ç½®
      working-directory: desktop
      run: |
        echo "package.json ç‰ˆæœ¬:"
        node -p "require('./package.json').version"
        echo ""
        echo "æ£€æŸ¥å›¾æ ‡æ–‡ä»¶:"
        ls -lh build/icon.icns || echo "icon.icns ä¸å­˜åœ¨"
        ls -lh assets/logo.png || echo "logo.png ä¸å­˜åœ¨"
    
    # 6. ç”Ÿæˆ macOS å›¾æ ‡
    - name: ç”Ÿæˆ macOS å›¾æ ‡
      working-directory: desktop
      run: |
        echo "=========================================="
        echo "å¼€å§‹ç”Ÿæˆ macOS å›¾æ ‡..."
        echo "=========================================="
        echo ""
        echo "æ£€æŸ¥æºæ–‡ä»¶:"
        ls -lh assets/logo.png || (echo "âŒ é”™è¯¯: assets/logo.png ä¸å­˜åœ¨ï¼" && exit 1)
        echo ""
        echo "æ£€æŸ¥ iconutil å‘½ä»¤æ˜¯å¦å¯ç”¨:"
        which iconutil || echo "âš ï¸ iconutil å‘½ä»¤ä¸å­˜åœ¨"
        echo ""
        echo "è¿è¡Œå›¾æ ‡ç”Ÿæˆè„šæœ¬..."
        npm run build:icon:mac 2>&1 | tee icon-build.log
        ICON_EXIT_CODE=${PIPESTATUS[0]}
        echo ""
        echo "å›¾æ ‡ç”Ÿæˆè„šæœ¬é€€å‡ºç : $ICON_EXIT_CODE"
        echo ""
        echo "æ£€æŸ¥ç”Ÿæˆçš„å›¾æ ‡ï¼š"
        if [ -f "build/icon.icns" ]; then
          ls -lh build/icon.icns
          echo "âœ“ icon.icns ç”ŸæˆæˆåŠŸ"
          echo ""
          echo "éªŒè¯ ICNS æ–‡ä»¶æ ¼å¼:"
          file build/icon.icns || echo "æ— æ³•æ£€æŸ¥æ–‡ä»¶ç±»åž‹"
        else
          echo "âŒ é”™è¯¯: build/icon.icns ä¸å­˜åœ¨ï¼"
          echo ""
          echo "build ç›®å½•å†…å®¹:"
          ls -lh build/ || echo "build ç›®å½•ä¸å­˜åœ¨"
          echo ""
          echo "å›¾æ ‡ç”Ÿæˆæ—¥å¿—ï¼š"
          cat icon-build.log
          exit 1
        fi
    
    # 7. æž„å»º macOS åº”ç”¨ï¼ˆä¸ç­¾åï¼‰
    - name: æž„å»º macOS åº”ç”¨
      working-directory: desktop
      run: |
        echo "å¼€å§‹æž„å»º macOS åº”ç”¨..."
        echo "electron-builder ç‰ˆæœ¬: $(npx electron-builder --version)"
        echo ""
        echo "=========================================="
        echo "å½“å‰ç›®å½•: $(pwd)"
        echo "package.json å†…å®¹æ£€æŸ¥:"
        if [ ! -f "package.json" ]; then
          echo "âŒ é”™è¯¯: package.json ä¸å­˜åœ¨ï¼"
          echo "å½“å‰ç›®å½•æ–‡ä»¶åˆ—è¡¨:"
          ls -lha
          exit 1
        fi
        echo "âœ“ package.json å­˜åœ¨"
        echo ""
        echo "æž„å»ºé…ç½®ï¼š"
        cat package.json | grep -A 50 '"build"' || echo "âš ï¸ æœªæ‰¾åˆ° build é…ç½®"
        echo ""
        echo "=========================================="
        echo "å¼€å§‹æž„å»º macOS åº”ç”¨ï¼ˆé€šç”¨äºŒè¿›åˆ¶ï¼‰"
        echo "=========================================="
        set +e  # å…è®¸å‘½ä»¤å¤±è´¥ï¼Œæˆ‘ä»¬æ‰‹åŠ¨æ£€æŸ¥é€€å‡ºç 
        npx electron-builder --mac --universal 2>&1 | tee build.log
        BUILD_EXIT_CODE=${PIPESTATUS[0]}
        set -e
        echo ""
        echo "æž„å»ºå‘½ä»¤é€€å‡ºç : $BUILD_EXIT_CODE"
        
        if [ $BUILD_EXIT_CODE -ne 0 ]; then
          echo ""
          echo "âŒâŒâŒ æž„å»ºå¤±è´¥ï¼ âŒâŒâŒ"
          echo ""
          echo "==================== å®Œæ•´æž„å»ºæ—¥å¿— ===================="
          cat build.log
          echo "==================== æ—¥å¿—ç»“æŸ ===================="
          echo ""
          echo "==================== é”™è¯¯åˆ†æž ===================="
          echo "æ£€æŸ¥ build ç›®å½•:"
          ls -lh build/ || echo "build ç›®å½•ä¸å­˜åœ¨"
          echo ""
          echo "æ£€æŸ¥ dist ç›®å½•:"
          ls -lh dist/ || echo "dist ç›®å½•ä¸å­˜åœ¨"
          echo ""
          exit 1
        else
          echo "âœ“ æž„å»ºå‘½ä»¤æ‰§è¡ŒæˆåŠŸ"
        fi
      env:
        CSC_IDENTITY_AUTO_DISCOVERY: false
        APPLEID: ""
        APPLEIDPASS: ""
        GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        DEBUG: "electron-builder,electron-builder:*"
    
    # 8. æ˜¾ç¤ºæž„å»ºç»“æžœ
    - name: æ˜¾ç¤ºæž„å»ºç»“æžœ
      if: always()
      working-directory: desktop
      run: |
        echo "=========================================="
        echo "æž„å»ºå®Œæˆï¼Œæ£€æŸ¥ç”Ÿæˆçš„æ–‡ä»¶"
        echo "=========================================="
        echo ""
        echo "å½“å‰ç›®å½•å†…å®¹:"
        ls -lha
        echo ""
        echo "dist ç›®å½•æ˜¯å¦å­˜åœ¨:"
        if [ -d "dist" ]; then
          echo "âœ“ dist ç›®å½•å­˜åœ¨"
          echo ""
          echo "dist ç›®å½•å®Œæ•´å†…å®¹:"
          ls -lhR dist/
          echo ""
          echo "=========================================="
          echo "æŸ¥æ‰¾ DMG æ–‡ä»¶:"
          find dist -name "*.dmg" -type f || echo "âš ï¸ æœªæ‰¾åˆ°ä»»ä½• DMG æ–‡ä»¶"
          echo ""
          echo "æŸ¥æ‰¾ ZIP æ–‡ä»¶:"
          find dist -name "*.zip" -type f || echo "âš ï¸ æœªæ‰¾åˆ°ä»»ä½• ZIP æ–‡ä»¶"
          echo ""
          echo "æŸ¥æ‰¾ APP æ–‡ä»¶:"
          find dist -name "*.app" -type d || echo "âš ï¸ æœªæ‰¾åˆ°ä»»ä½• APP æ–‡ä»¶"
        else
          echo "âŒ dist ç›®å½•ä¸å­˜åœ¨ï¼æž„å»ºå¤±è´¥äº†"
          echo ""
          echo "æŸ¥çœ‹æž„å»ºæ—¥å¿—:"
          if [ -f "build.log" ]; then
            echo "==================== æž„å»ºæ—¥å¿— ===================="
            cat build.log
          else
            echo "âš ï¸ build.log ä¸å­˜åœ¨"
          fi
        fi
    
    # 9. ä¸Šä¼ æž„å»ºæ—¥å¿—ï¼ˆå¤±è´¥æ—¶ï¼‰
    - name: ä¸Šä¼ æž„å»ºæ—¥å¿—
      if: failure()
      uses: actions/upload-artifact@v4
      with:
        name: build-logs
        path: |
          desktop/build.log
          desktop/dist/**/*
        if-no-files-found: ignore
    
    # 10. ä¸Šä¼ æž„å»ºäº§ç‰©
    - name: ä¸Šä¼ æž„å»ºäº§ç‰©
      if: success()
      uses: actions/upload-artifact@v4
      with:
        name: macos-dmg-files
        path: |
          desktop/dist/*.dmg
          desktop/dist/*.zip
          desktop/dist/latest-mac.yml
        if-no-files-found: warn
    
    # 10. ä¸Šä¼ åˆ° GitHub Release
    - name: å‘å¸ƒåˆ° Release
      if: startsWith(github.ref, 'refs/tags/')
      uses: softprops/action-gh-release@v1
      with:
        files: |
          desktop/dist/*.dmg
          desktop/dist/*.zip
        draft: false
        prerelease: false
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
    
    # 11. æž„å»ºæ‘˜è¦
    - name: ç”Ÿæˆæž„å»ºæ‘˜è¦
      if: always()
      run: |
        echo "## macOS æž„å»ºæ‘˜è¦" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "| é¡¹ç›® | å€¼ |" >> $GITHUB_STEP_SUMMARY
        echo "|------|-----|" >> $GITHUB_STEP_SUMMARY
        
        # è¯»å–ç‰ˆæœ¬å·ï¼ˆå¸¦é”™è¯¯å¤„ç†ï¼‰
        VERSION=$(node -p "require('./desktop/package.json').version" 2>/dev/null || echo "æœªçŸ¥")
        echo "| ç‰ˆæœ¬ | $VERSION |" >> $GITHUB_STEP_SUMMARY
        echo "| å¹³å° | macOS (Intel + Apple Silicon) |" >> $GITHUB_STEP_SUMMARY
        echo "| æž„å»ºæ—¶é—´ | $(date '+%Y-%m-%d %H:%M:%S') |" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        
        # æ£€æŸ¥æž„å»ºç»“æžœ
        if [ -d "desktop/dist" ]; then
          if ls desktop/dist/*.dmg 1> /dev/null 2>&1; then
            echo "### âœ… æž„å»ºæˆåŠŸï¼ç”Ÿæˆçš„æ–‡ä»¶ï¼š" >> $GITHUB_STEP_SUMMARY
            for file in desktop/dist/*.dmg; do
              size=$(du -h "$file" | cut -f1)
              echo "- \`$(basename "$file")\` - $size" >> $GITHUB_STEP_SUMMARY
            done
          else
            echo "### âš ï¸ dist ç›®å½•å­˜åœ¨ï¼Œä½†æœªæ‰¾åˆ° DMG æ–‡ä»¶" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "**dist ç›®å½•å†…å®¹:**" >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
            ls -lhR desktop/dist/ 2>/dev/null || echo "æ— æ³•åˆ—å‡ºç›®å½•å†…å®¹" >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            
            # æ˜¾ç¤ºæž„å»ºæ—¥å¿—
            if [ -f "desktop/build.log" ]; then
              echo "<details>" >> $GITHUB_STEP_SUMMARY
              echo "<summary>ðŸ“‹ ç‚¹å‡»æŸ¥çœ‹å®Œæ•´æž„å»ºæ—¥å¿—</summary>" >> $GITHUB_STEP_SUMMARY
              echo "" >> $GITHUB_STEP_SUMMARY
              echo '```' >> $GITHUB_STEP_SUMMARY
              cat desktop/build.log >> $GITHUB_STEP_SUMMARY
              echo '```' >> $GITHUB_STEP_SUMMARY
              echo "</details>" >> $GITHUB_STEP_SUMMARY
            fi
          fi
        else
          echo "### âŒ æž„å»ºå¤±è´¥ï¼šdist ç›®å½•ä¸å­˜åœ¨" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          if [ -f "desktop/build.log" ]; then
            echo "<details>" >> $GITHUB_STEP_SUMMARY
            echo "<summary>ðŸ“‹ ç‚¹å‡»æŸ¥çœ‹å®Œæ•´æž„å»ºæ—¥å¿—</summary>" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
            cat desktop/build.log >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
            echo "</details>" >> $GITHUB_STEP_SUMMARY
          else
            echo "âš ï¸ æž„å»ºæ—¥å¿—æ–‡ä»¶ä¸å­˜åœ¨" >> $GITHUB_STEP_SUMMARY
          fi
        fi
